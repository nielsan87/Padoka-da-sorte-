package main

import (
	"fmt"
	"html/template"
	"math/rand"
	"net/http"
	"strconv"
	"time"
)

var symbols = []string{"ğŸ", "ğŸ¥–", "ğŸ°", "ğŸ§", "ğŸ¥"}

type SlotResult struct {
	Reel1    string
	Reel2    string
	Reel3    string
	Message  string
	Credits  int
	BetValue int
}

var tpl = template.Must(template.New("slot").Parse(`
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Padoka da Sorte ğŸ°</title>
<style>
  body { font-family: Arial, sans-serif; text-align: center; padding: 50px; background: #fff8e1; }
  h1 { color: #d2691e; }
  .reels { font-size: 80px; margin: 20px 0; }
  button, input[type=number] { font-size: 24px; padding: 10px 20px; border-radius: 10px; }
  button { background: #f4a261; border: none; cursor: pointer; }
  button:hover { background: #e76f51; color: white; }
  input[type=number] { width: 120px; }
  .message { font-size: 28px; margin-top: 30px; color: #2a9d8f; }
  .credits { font-size: 22px; margin-top: 20px; color: #6b4226; }
  .bet-label { font-size: 18px; margin-right: 10px; }
</style>
</head>
<body>
  <h1>Padoka da Sorte ğŸ°</h1>
  <div class="credits">CrÃ©ditos: {{.Credits}}</div>
  {{if ge .Credits 100}}
  <form method="POST" action="/">
    <input type="hidden" name="credits" value="{{.Credits}}">
    <label class="bet-label" for="bet">Valor da aposta:</label>
    <input type="number" id="bet" name="bet" min="100" max="{{.Credits}}" value="{{.BetValue}}" required>
    <div class="reels">{{.Reel1}} | {{.Reel2}} | {{.Reel3}}</div>
    <button type="submit">Girar</button>
  </form>
  {{else}}
  <div class="message">ğŸ˜ CrÃ©ditos insuficientes para jogar.</div>
  {{end}}
  {{if .Message}}
  <div class="message">{{.Message}}</div>
  {{end}}
</body>
</html>
`))

func spin() (string, string, string) {
	rand.Seed(time.Now().UnixNano())
	return symbols[rand.Intn(len(symbols))],
		symbols[rand.Intn(len(symbols))],
		symbols[rand.Intn(len(symbols))]
}

func checkWin(r1, r2, r3 string) bool {
	return r1 == r2 && r2 == r3
}

func handler(w http.ResponseWriter, r *http.Request) {
	credits := 17000 // valor inicial
	betValue := 500  // aposta padrÃ£o

	if r.Method == http.MethodPost {
		credStr := r.FormValue("credits")
		if c, err := strconv.Atoi(credStr); err == nil {
			credits = c
		}

		betStr := r.FormValue("bet")
		if b, err := strconv.Atoi(betStr); err == nil {
			betValue = b
		}

		if betValue < 100 {
			betValue = 100
		}
		if betValue > credits {
			betValue = credits
		}

		if credits < betValue {
			data := SlotResult{
				Reel1:    "â“",
				Reel2:    "â“",
				Reel3:    "â“",
				Message:  "ğŸ˜ CrÃ©ditos insuficientes para essa aposta.",
				Credits:  credits,
				BetValue: betValue,
			}
			tpl.Execute(w, data)
			return
		}

		credits -= betValue

		r1, r2, r3 := spin()
		message := ""

		if checkWin(r1, r2, r3) {
			winAmount := betValue * 4
			credits += winAmount
			message = fmt.Sprintf("ğŸ‰ ParabÃ©ns! VocÃª ganhou %d crÃ©ditos na Padoka da Sorte! ğŸ‰", winAmount)
		} else {
			message = "Tente de novo! ğŸğŸ¥–ğŸ°ğŸ§ğŸ¥"
		}

		data := SlotResult{
			Reel1:    r1,
			Reel2:    r2,
			Reel3:    r3,
			Message:  message,
			Credits:  credits,
			BetValue: betValue,
		}

		tpl.Execute(w, data)
		return
	}

	data := SlotResult{
		Reel1:    "â“",
		Reel2:    "â“",
		Reel3:    "â“",
		Message:  "",
		Credits:  credits,
		BetValue: betValue,
	}
	tpl.Execute(w, data)
}

func main() {
	http.HandleFunc("/", handler)
	fmt.Println("Servidor rodando em http://localhost:8080")
	err := http.ListenAndServe(":8080", nil)
	if err != nil {
		fmt.Println("Erro ao iniciar servidor:", err)
	}
}
